<!DOCTYPE HTML>
<html>
<head>
    <title>Flask-SocketIO Test</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>
<body>
<div class="container">
    <h2>Test</h2>
<div>
    <strong>Phone:</strong><br/>
    <label for="phoneAvailability">Availability</label>
    <input type="checkbox" id="phoneAvailability" checked>
    <br/>
    <label for="phoneAvailability">Battery</label>
    <input type="number" id="phoneBattery" value="100">
    <br/><br/>
    <strong>Watch:</strong><br/>
    <label for="watchAvailability">Availability</label>
    <input type="checkbox" id="watchAvailability">
    <br/>
    <label for="watchBattery">Battery</label>
    <input type="number" id="watchBattery" value="80">
    <br/>
    <br/>
    <button class="btn btn-warning" onclick="sendDeviceData()">Send</button>
</div>
<hr/>
<form id="disconnect" method="POST" action="#">
    <input class="btn btn-sm btn-danger" type="submit" value="Disconnect">
</form>
<div id="log"></div>
<div id="deviceStatus"></div>
<div id="phoneData"></div>
<h2>Current Activity: <span id="currentActivity"></span></h2>
<canvas id="myChart" height="200"></canvas>
</div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
        integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
        integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<script type="text/javascript" charset="utf-8">
    let socket = null;
    let x = [];
    let y = [];
    let z = [];
    let lables = [];
    let chart;
    const activities = {
        "A": "walking",
        "B": "jogging",
        "C": "stairs",
        "D": "sitting",
        "E": "standing",
        "F":"typing",
        "G": "teeth",
        "H": "soup",
        "I": "chips",
        "J": "pasta",
        "K": "drinking",
        "L": "sandwich",
        "M": "kicking",
        "O": "catch",
        "P": "dribbling",
        "Q": "writing",
        "R": "clapping",
        "S": "folding",
    }
    $(document).ready(function () {
        initializeChart();
        // Connect to the Socket.IO server.
        // The connection URL has the following format, relative to the current page:
        //     http[s]://<domain>:<port>[/<namespace>]
        socket = io();

        // Event handler for new connections.
        // The callback function is invoked when a connection with the
        // server is established.
        socket.on('connect', function () {
            socket.emit('my_event', {data: 'I\'m connected!'});
        });

        // Event handler for server sent data.
        // The callback function is invoked whenever the server emits data
        // to the client. The data is then displayed in the "Received"
        // section of the page.
        socket.on('my_response', function (msg, cb) {
            $('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data).html());
            if (cb)
                cb();
        });

        socket.on('device_status_response', function (msg, cb) {
            $('#deviceStatus').html(JSON.stringify(msg.data));
            if (cb)
                cb();
        });


        socket.on('prediction', function (msg, cb) {
            console.log(msg.data)
            if (cb)
                cb();
        });

        socket.on('phone_data', function (msg, cb) {
            const phoneData = JSON.parse(msg.data)[0];
            $('#phoneData').html(JSON.stringify(phoneData));
            $('#currentActivity').text(activities[phoneData['activity']]);
            lables.push(phoneData['timestamp']);
            x.push(phoneData['phone-accel-x']);
            y.push(phoneData['phone-accel-y']);
            z.push(parseFloat(phoneData['phone-accel-z']));
            if(lables.length > 100){
                lables.shift();
                x.shift();
                y.shift();
                z.shift();
            }
            chart.update();
            if (cb)
                cb();
        });

        // Handlers for the different forms in the page.
        // These accept data from the user and send it to the server in a
        // variety of ways
        $('form#emit').submit(function (event) {
            socket.emit('my_event', {data: $('#emit_data').val()});
            return false;
        });

        $('form#broadcast').submit(function (event) {
            socket.emit('my_broadcast_event', {data: $('#broadcast_data').val()});
            return false;
        });

        $('form#disconnect').submit(function (event) {
            socket.emit('disconnect_request');
            return false;
        });
    });

    const initializeChart = () => {
        var ctx = document.getElementById('myChart').getContext('2d');
        document.getElementById('myChart').height = 100;
        chart = new Chart(ctx, {
            // The type of chart we want to create
            type: 'line',

            // The data for our dataset
            data: {
                labels: lables,
                datasets: [{
                    label: 'x',
                    borderColor: 'rgb(255, 99, 132)',
                    fill: false,
                    data: x
                },
                {
                    label: 'y',
                    borderColor: 'rgb(255,152,0)',
                    fill: false,
                    data: y
                },
                {
                    label: 'z',
                    borderColor: 'rgb(0,166,255)',
                    fill: false,
                    data: z
                }]
            },

            // Configuration options go here
            options: {}
        });
    }

    const sendDeviceData = () => {
        const phoneAvailability = $('#phoneAvailability').is(":checked");
        const phoneBattery = $('#phoneBattery').val();
        const watchAvailability = $('#watchAvailability').is(":checked");
        const watchBattery = $('#watchBattery').val();

        const data = [
            {
                device: 'watch',
                availability: watchAvailability,
                battery: watchBattery
            },
            {
                device: 'phone',
                availability: phoneAvailability,
                battery: phoneBattery
            }
        ]
        socket.emit('device_status', data);
    }
</script>
</html>