<!DOCTYPE HTML>
<html>
<head>
    <title>Flask-SocketIO Test</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>
<body>
<div class="container-flex" style="padding: 50px;">
    <h2>Demonstration</h2>
    <div>
        <strong>Phone:</strong><br/>
        <label for="phoneAvailability">Availability</label>
        <input type="checkbox" id="phoneAvailability" checked>
        <br/>
        <label for="phoneAvailability">Battery</label>
        <input type="number" id="phoneBattery" value="100">
        <br/><br/>
        <strong>Watch:</strong><br/>
        <label for="watchAvailability">Availability</label>
        <input type="checkbox" id="watchAvailability">
        <br/>
        <label for="watchBattery">Battery</label>
        <input type="number" id="watchBattery" value="80">
        <br/>
        <br/>
        <button class="btn btn-warning" onclick="sendDeviceData()">Send</button>
    </div>
    <hr/>
    <form id="disconnect" method="POST" action="#">
        <input class="btn btn-sm btn-danger" type="submit" value="Disconnect">
    </form>
    <div id="log"></div>
    <div id="deviceStatus"></div>
    <div id="phoneData"></div>
    <h2>Current Activity: <span id="currentActivity"></span></h2>
    <h2>Selected Model: <span id="selectedModel"></span></h2>
    <canvas id="myChart" height="200"></canvas>
</div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
        integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
        integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<script type="text/javascript" charset="utf-8">
    let socket = null;
    let phoneX = [];
    let phoneY = [];
    let phoneZ = [];
    let watchX = [];
    let watchY = [];
    let watchZ = [];
    let lables = [];
    let chart;
    const activities = {
        "A": "walking",
        "B": "jogging",
        "C": "stairs",
        "D": "sitting",
        "E": "standing",
        "F": "typing",
        "G": "teeth",
        "H": "soup",
        "I": "chips",
        "J": "pasta",
        "K": "drinking",
        "L": "sandwich",
        "M": "kicking",
        "O": "catch",
        "P": "dribbling",
        "Q": "writing",
        "R": "clapping",
        "S": "folding",
    }
    $(document).ready(function () {
        initializeChart();
        // Connect to the Socket.IO server.
        // The connection URL has the following format, relative to the current page:
        //     http[s]://<domain>:<port>[/<namespace>]
        socket = io();

        socket.on('model_change', function (msg, cb) {
            console.log(msg)
            if (cb)
                cb();
        });


        socket.on('prediction', function (msg, cb) {
            let activity = 'No sensors available'
            if (msg.data.prediction !== null) {
                activity = activities[msg.data.prediction]
            }
            $('#currentActivity').text(activity);
            if (cb)
                cb();
        });

        socket.on('sensor_data', function (msg, cb) {
            const phoneData = JSON.parse(msg.data)[0];
            $('#phoneData').html(JSON.stringify(phoneData));
            $('#selectedModel').text(msg.current_model_key);
            lables.push(phoneData['timestamp']);
            phoneX.push(phoneData['phone-accel-x']);
            phoneY.push(phoneData['phone-accel-y']);
            phoneZ.push(phoneData['phone-accel-z']);
            watchX.push(phoneData['watch-accel-x']);
            watchY.push(phoneData['watch-accel-y']);
            watchZ.push(phoneData['watch-accel-z']);
            if (lables.length > 300) {
                lables.shift();
                phoneX.shift();
                phoneY.shift();
                phoneZ.shift();
                watchX.shift();
                watchY.shift();
                watchZ.shift();
            }
            chart.update();
            if (cb)
                cb();
        });

        // Handlers for the different forms in the page.
        // These accept data from the user and send it to the server in a
        // variety of ways
        $('form#emit').submit(function (event) {
            socket.emit('my_event', {data: $('#emit_data').val()});
            return false;
        });

        $('form#broadcast').submit(function (event) {
            socket.emit('my_broadcast_event', {data: $('#broadcast_data').val()});
            return false;
        });

        $('form#disconnect').submit(function (event) {
            socket.emit('disconnect_request');
            return false;
        });
    });

    const initializeChart = () => {
        var ctx = document.getElementById('myChart').getContext('2d');
        document.getElementById('myChart').height = 80;
        chart = new Chart(ctx, {
            // The type of chart we want to create
            type: 'line',

            // The data for our dataset
            data: {
                labels: lables,
                datasets: [{
                    label: 'phone accel x',
                    borderColor: 'rgb(255, 99, 132)',
                    fill: false,
                    data: phoneX
                },
                    {
                        label: 'phone accel y',
                        borderColor: 'rgb(255,152,0)',
                        fill: false,
                        data: phoneY
                    },
                    {
                        label: 'phone accel z',
                        borderColor: 'rgb(0,166,255)',
                        fill: false,
                        data: phoneZ
                    },
                    {
                        label: 'watch accel x',
                        borderColor: 'rgb(34,166,179)',
                        fill: false,
                        data: watchX
                    },
                    {
                        label: 'watch accel y',
                        borderColor: 'rgb(56,103,214)',
                        fill: false,
                        data: watchY
                    },
                    {
                        label: 'watch accel z',
                        borderColor: 'rgb(75,101,132)',
                        fill: false,
                        data: watchZ
                    }]
            },

            // Configuration options go here
            options: {}
        });
    }

    const sendDeviceData = () => {
        const phoneAvailability = $('#phoneAvailability').is(":checked");
        const phoneBattery = $('#phoneBattery').val();
        const watchAvailability = $('#watchAvailability').is(":checked");
        const watchBattery = $('#watchBattery').val();

        const data = [
            {
                name: 'watch',
                isAvailable: watchAvailability,
                battery: watchBattery
            },
            {
                name: 'phone',
                isAvailable: phoneAvailability,
                battery: phoneBattery
            }
        ]
        socket.emit('device_status', data);
    }
</script>
</html>